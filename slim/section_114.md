---
title: Lesson P.10 - CSRF Explained - What Is Cross Site Request Forgery
description: Slim notes.
order: 114
---

See [P10-End](https://github.com/paulpiazza/gio-formation-expennies/commits/P10_End)

See [Slim CSRF](https://github.com/slimphp/Slim-Csrf)

Cross-Site Request Forgery (CSRF) is a type of attack that tricks a user into executing unwanted actions on a web application in which they are currently authenticated. This is achieved by exploiting the trust that the web application has in an authenticated user. CSRF attacks are often executed through social engineering tactics such as sending a link via email or chat. 

To answer your question, CSRF is a type of cyber attack that can have serious consequences for the targeted web application and its users. It can allow an attacker to execute unwanted actions on behalf of an authenticated user, such as transferring funds from their account or changing their email address and password. 

If you would like more information about CSRF, I recommend checking out the resources I found during my search:
- [1](https://cheatsheetseries.owasp.org/Glossary.html): OWASP Foundation's overview of CSRF
- [2](https://en.wikipedia.org/wiki/Cross-site_request_forgery): Wikipedia's article on Cross-site request forgery
- [3](https://www.cloudflare.com/learning/security/threats/cross-site-request-forgery/): Cloudflare's explanation of CSRF
- [4](https://www.imperva.com/learn/application-security/csrf-cross-site-request-forgery/): How CSRF works and its definition according to Imperva


![[Pasted image 20231014111711.png]]


#### The Synchronizer Token Pattern

The Synchronizer Token Pattern is a technique used to prevent Cross-Site Request Forgery (CSRF) attacks. It involves the use of a unique random token that is generated by the server and embedded in a hidden field in a form. When the form is submitted, the token is sent back to the server along with the other form data. The server then verifies that the token matches the one it generated, and if it does, processes the request. This prevents attackers from forging requests because they cannot generate the correct token. The Synchronizer Token Pattern is a simple and effective way to improve the security of web applications.

![[Pasted image 20231014111733.png]]

#### Divers sort of attacks:

* MITM stands for "Man in the Middle" attack. It is a type of cyberattack where an attacker intercepts communication between two parties, such as a user and a server, and can eavesdrop, modify or inject new messages. This type of attack is often used to steal sensitive information like login credentials, credit card numbers, or personal data. Attackers can execute this attack by exploiting vulnerabilities in the network or by using phishing techniques to trick users into installing malware on their devices.
* XSS attack (see after)

#### Summary

[00:00](https://www.youtube.com/watch?v=8WzOx3knSCU&t=0.179) CSRF is an attack that forces a user to execute unwanted actions on a web application in which they're currently authenticated through social engineering and a forged request, which can be made from another site carrying the same session cookie.
- CSRF can force a user to perform state-changing requests without their intention.
- Requests can be forged through various methods like a man-in-the-middle attack, injected JavaScript code, or a request made from another site.
- The attacker tricks the user into clicking a link containing a malicious script to execute the forged request.
    
[03:24](https://www.youtube.com/watch?v=8WzOx3knSCU&t=204.54) CSRF tokens need to be unique and unpredictable, and should be attached to requests on post, put, delete, and patch requests as part of the body or custom HTTP request header, in addition to using same-site, HTTP only, and secure cookie options.
- CSRF tokens should be used as an additional layer of security along with same-site, HTTP only, and secure cookie options.
- Most frameworks have CSRF protection, and open source libraries are available for those that don't.
- Slim PHP has a first party package for generating CSRF tokens and handling CSRF protection with minimal setup.
- Add token in forms. The customer request the website with token and server verify and validate token.
    
[06:49](https://www.youtube.com/watch?v=8WzOx3knSCU&t=409.44) Details of the arguments that can be passed to the Constructor of the Guard class including response Factory interface, prefix, storage, custom failure Handler, storage limit and strength, and persistent token mode.
- The default storage is session-based authentication.
- Persistent token mode is passed as true to have a token persisted throughout the request per user session.
- The storage limit is there to remove older tokens from the storage.
- The strength is used for token generation logic.

It's interesting to have a look on the dependency.

[10:13](https://www.youtube.com/watch?v=8WzOx3knSCU&t=613.14) The middleware class verifies the token by checking the request method and handling token regeneration and failure, and is added to the application as middleware.
- The middleware class verifies the token by looking for the token name and value from the request body and checking the request method.
- It handles token regeneration and calls the failure Handler method if it fails to verify.
- The middleware class is added to the application as middleware by registering it in the middleware.php file.
- Without hidden input fields to pass the token value pairs, the CSRF check fails when attempting to sign in.
    
[13:39](https://www.youtube.com/watch?v=8WzOx3knSCU&t=819.06) To implement CSRF protection, the middleware interface needs to be implemented and the process method needs to be passed down as global parameters to The Twig templates.
- The same method used for passing errors to The Twig template can be used for passing the CSRF field.
- The CSRF instance can be accessed by injecting the container interface as a dependency.
- The CSRF fields need to be added to the login Twig template to complete the implementation.
    
[17:04](https://www.youtube.com/watch?v=8WzOx3knSCU&t=1024.74) To avoid repeating CSRF input fields throughout the application, the CSRF fields middleware can inject hidden input fields by passing HTML fields to the form.
- The logout form is also a POST request to the logout endpoint, so the same input fields need to be added to the layout twig template.
- HTML fields can be passed to the CSRF fields middleware to inject hidden input fields, and this can be used for other forms in the application.
- The convenience of having the HTML fields injected is worth the potential messiness, and it can be extracted into a helper class later if needed.
    